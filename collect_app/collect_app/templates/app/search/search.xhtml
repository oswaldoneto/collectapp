{% extends "layout/template.xhtml" %}

{% load guardian_tags %}
{% load permission_checker %}
{% load highlight %}
{% load kilobytefy %}

{% block title %}Collect Project :: Documento{% endblock %}

{% block import_style %}
	<link rel="stylesheet" href="{{STATIC_URL}}css/app/search.css" />	
	<style type="text/css">
		table.table_result {
			background-color: #ffffff;
			width: 100%;
			border: solid 1px #d4ccb0;
		}
		table.table_result td {
			padding-top: 10px;
			padding-bottom: 10px;			
		}
		table.table_result tr > td {
			border-bottom: solid 1px #d4ccb0;
		}
		table.table_result tr:last-child > td {
			border-bottom: none;
		}		
		/* REFACTOR: UNIR CODIGO ABAIXO COM O DA PAGINA DOCUMENT_PREVIEW.XHTML */
		table.attribute_table {
	        border-collapse:collapse;			
			width: 100%;	
		}
		
		table.attribute_table td  {
			/*border: 1px solid #d4ccb0;*/
			padding: 0px 3px;
		}		
		/* REFACTOR: UNIR CODIGO ABAIXO COM O DA PAGINA DOCUMENT_PREVIEW.XHTML */
		</style>
{% endblock %}

{% block startup_script %}
	<script type="text/javascript" src="{{STATIC_URL}}js/jquery/plugin/caroufredsel/jquery.carouFredSel-6.2.1-packed.js"></script>
	<script type="text/javascript">
		$(document).ready(function() {
			/** Settings */
			/** Events */
			$("#uic_lookup_link").click(function(){
				$("#uic_form").submit(); 
				return false;			
			});
						
			$("a[rel=uic_preview_link]").live("click",function(){
				redirect(sprintf("/document/%s/preview",$(this).attr('href')));
				return false;
			});
			  
			$("a[rel=uic_classify_link]").live("click",function(){
				redirect(sprintf("/document/%s/classify",$(this).attr('href')));
				return false;
			});

			$("a[rel=uic_permission_link]").live("click",function(){
				redirect(sprintf("/document/%s/permission",$(this).attr('href')));								
				return false;
			});
			
			$("a[rel=uic_delete_link]").live("click",function(){
				var document_id = $(this).attr('href');								
				$("#uic_delete_dialog").dialog({
					title:"Deletar Documento",
					modal:true,
					buttons:[
						{
							text: "Yes",
							click: function() { 
								$("#uic_delete_form").attr("action", sprintf("/document/%s/delete",document_id));  
								$("#uic_delete_form").submit();
								return false;								
							}
						},
						{
							text: "No",
							click: function() { 
								$(this).dialog("close"); 
							}
						}					
					] 
				});
				return false;
			});
			
			
			
			$("a[rel=uic_category_facelet_link]").live("click",function(){
				$("#id_selected_category").val($(this).attr('href'));
				$("#uic_form").submit(); 
				return false;
			});
			
			
			$("#uic_clear_category_facelet_link").click(function(){
				$("#id_selected_category").val('');
				$("#uic_form").submit(); 
				return false;
			});
			
			$("a[rel=uic_tag_facelet_link]").live("click",function(){
				$("#id_selected_tag").val($(this).attr('href'));
				$("#uic_form").submit(); 
				return false;
			});
			
			
			$("#uic_clear_tag_facelet_link").click(function(){
				$("#id_selected_tag").val('');
				$("#uic_form").submit(); 
				return false;
			});		
			
			
			//TODO: Refactor unir com o document_preview.xhtml
			$("#uic_download-file_link").live("click",function(){
				var key = $(document).data("selected-key");
				$.get(sprintf(sprintf("/api/storage/key/%s",key)),{}, function(data){					
					window.location=data.url_to_download; 
				}).error(function(){
					alert("Erro ao obter a url do arquivo");
				});					
			});
			
			//TODO: Refactor unir com o document_preview.xhtml
			$("#uic_visualize-file_link").live("click",function(){				
				var key = $(document).data("selected-key");
				$.get(sprintf(sprintf("/api/storage/key/%s",key)),{}, function(data){					
					$.fancybox.open([
					    {
					        href : data.url_to_preview,
					        title : data.filename,
					    }    
					], {
						type : 'iframe',
						padding    : 0,
    					autoResize : false,
						maxWidth   : 800,
						maxHeight  : 600,
						fitToView  : false,
						width	   : '70%',
						height	   : '70%',
						minWidth   : 400,
						minHeight  : 300,
					});
				}).error(function(){
					alert("Erro ao obter a url do arquivo");
				});					
				return false;				
			});
			
			
			{% for result in page.object_list %}
				{% if result.object.all_files %}
					$(sprintf("#uic_file_list_%s","{{forloop.counter}}")).carouFredSel({
						align: "left",
						circular: false,
    					infinite: false,
    					auto    : false,
						pagination: '#uic_{{forloop.counter}}_pages',
					});
					
				{% endif %}	
			{% endfor  %}	
			
			
			
			
			$('.uic_file_tooltip').toolbar({
				content: '#user-toolbar-options',
				position: 'bottom',
				hideOnClick: true,
			});
			$(".uic_file_tooltip").on('toolbarShown',
				function( event ) {
					var key = $(this).find("a[rel=uic_file-key_link]").attr('href');
					$(document).data("selected-key",key);
				}
			);
			$(".uic_file_tooltip").on('toolbarItemClick',
				function( event ) {
					$(this).trigger('click');
				}
			);
			
									
			


		});	
	</script>
{% endblock %}

{% block trail %}
    <ul>
        <li><a href="#">Home</a></li>
        <li>Pesquisa</li>
    </ul>
{% endblock %}

{% block context_menu %}
	{% if query %}
		{% if categories.fields.category %}
			<div style="margin-top: 10px" class="ui-widget ui-widget-content ui-corner-all">
				<dl class="ui-context-menu">
					<dt>Categorias
					{% if form.selected_category.value %}
						<a id="uic_clear_category_facelet_link">
						<span class="floatr"><i class="icon-reply"></i></span>
						</a>
					{% endif %}
					</dt>
					{% for cat in categories.fields.category %}
						<dd><a rel="uic_category_facelet_link" href="{{cat.0}}">{{cat.0}} ({{cat.1}})</a></dd>
					{% endfor %}
				</dl>
			</div>
		{% endif %}
		{% if tags.fields.tags %}
			<div style="margin-top: 10px" class="ui-widget ui-widget-content ui-corner-all">
				<dl class="ui-context-menu">
					<dt>Tags
					{% if form.selected_tag.value %}
						<a id="uic_clear_tag_facelet_link">
						<span class="floatr"><i class="icon-reply"></i></span>
						</a>
					{% endif %}
					</dt>			
					{% for tag in tags.fields.tags %}
						<dd><a rel="uic_tag_facelet_link" href="{{tag.0}}">{{tag.0}} ({{tag.1}})</a></dd>
					{% endfor %}
				</dl>
			</div>
		{% endif %}
	{% endif %}
{% endblock %}

{% block content %}
	<!-- Header -->
	<div class="ui-app-header">
		<div class="ui-app-title">Pesquisar Documentos</div>
	</div>
	<!-- Search -->	
	<form id="uic_form" method="get" class="ui-form ui-widget ui-widget-content ui-corner-all">
		{% csrf_token %}
		{{form.selected_category}}		
		{{form.selected_tag}}			
		<div id="search_wrapper">
			{{form.q}}
			<a id="uic_lookup_link" href="">
				<i class="icon-search icon-large floatr"></i>
			</a>
		</div>
	</form>		
	<!-- Result -->
	{% if query %}
		<div class="ui-widget-header ui-corner-top" style="padding: 3px 10px 3px 10px; margin-top: 20px; border-bottom: none;">
			<div style="float: left"><p></span>Resultado da Busca</p></div>
			<div style="float: right;">
				<p style="font-weight: bold;"> {{page.paginator.count}} documento{{page.paginator.count|pluralize}} encontrado{{page.paginator.count|pluralize}}</p>
			</div>
			<div class="clear"></div>		
		</div>
		<div class="ui-widget-content ui-corner-bottom" style="padding: 10px 10px;">
			
			
			
	        {% if page.has_previous or page.has_next %}		        
		        <div class="ui-paginator">	
		        	<div>	        	
		        		{% if page.has_previous %}
		        			<a href="?q={{ query }}&amp;page={{ page.previous_page_number }}">
					        	<i class="icon-circle-arrow-left"></i>
					        </a>
				        {% endif %}		        		
			        	<b>1 de 2</b>
		        		{% if page.has_next %}
		        			<a href="?q={{ query }}&amp;page={{ page.next_page_number }}">
			        			<i class="icon-circle-arrow-right"></i>
			        		</a>
			        	{% endif %}
		        	</div>		        	
		        </div>
			{% endif %}
			
			
			
			
			
			<div id="user-toolbar-options" class="hide">
				<a id="uic_download-file_link"><i class="icon-cloud-download icon-2x"></i></a>
				<a id="uic_visualize-file_link"><i class="icon-external-link-sign icon-2x"></i></a>
			</div>
			
			
			
			<table class="table_result ui-corner-all">
				{% for result in page.object_list %}
					{% get_public_perms result.object as public_permissions %}
					{% get_obj_perms user for result.object as "document_permissions" %}
					<tr class="{% cycle 'row1' 'row2' %}">
						<td>
							<div class="margin_min_left margin_min_right">
								<!-- Files -->
								<div class="floatl">
									<div class="pagination margin_min_bottom" id="uic_{{forloop.counter}}_pages"></div>
									<div style="float: left; width: 450px;">
										{% if result.object.all_files %}	
											<div class="list_carousel">
												<ul id="uic_file_list_{{forloop.counter}}">		
													{% for attach in result.object.all_files %}								
														<li>
															<div class="uic_file_tooltip floatl margin_right_default margin_min_bottom ui-widget ui-widget-content ui-corner-all padding_default">
																<a rel="uic_file-key_link" href="{{attach.file.key}}"></a>
																<div>
																	<span style="font-size: 20px"><i class="icon-file"></i></span> {% highlight attach.file.filename with query %}														
																</div>
																<p class="floatl ui-state-disabled margin_min_right" style="font-size: 0.8em">{{attach.file.filetype}}</p>
																<p class="floatr ui-state-disabled margin_min_left" style="font-size: 0.8em">{{attach.file.filesize|kilobytefy}}</p>
																												
															</div>													
														</li>
													{% endfor %}
												</ul>
											</div>
										{% else %}
											<div class="ui-state-disabled margin_min_bottom">												
												Nenhum arquivo encontrado																																		
											</div>													
										{% endif %}	
									</div>
									{% if result.object.all_tags %}	
										<div style="max-width: 450px;">
											{% for tag in result.object.all_tags  %}
												<div class="ui-state-active ui-corner-all floatl margin_min_bottom margin_min_right" style="padding: 2px">
													<p style="font-size: 0.8em; font-weight: bold">{% highlight tag.name with query %}</p>
												</div>
											{% endfor %}									
										</div>	
									{% endif %}										
								</div>
								<!-- Classification -->
								<div class="floatr" style="max-width: 280px;">
									<div>
										{% if result.object.category %}
											<span>{% highlight result.object.category.title with query %}</span>
											<small><i class="icon-caret-right"></i></small>		
											<span class="font_min">{% highlight result.object.owner.username with query %}</span>
										{% else %}
											<div class="ui-widget ui-corner-all ui-state-disabled">												
												Não classificado																																		
											</div>												
										{% endif %}			
									</div>
									{% if result.object.all_attributes %}
										<div class="margin_r_double">
											{% for att in result.object.all_attributes %}
												{% if att.value %}
													<div class="margin_min_top">
														<span class="ui-state-disabled" style="font-size: .8em; font-weight: bold; ">{{att.attribute.name}}</span>
														<small><i class="icon-angle-right ui-state-disabled"></i></small>
														<span>{% highlight att.value.value with query %}</span>
													</div> 
												{% endif %}					
											{% endfor %}
										</div>
									{% endif %}	
								</div								
							</div>
							<div class="clear"></div>																					
						</td>
					</tr>	
				{% endfor %}
			</table>
		</div>
	{% endif %}
{% endblock %}