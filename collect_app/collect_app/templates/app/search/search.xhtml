{% extends "layout/template.xhtml" %}

{% load guardian_tags %}
{% load permission_checker %}
{% load highlight %}
{% load kilobytefy %}

{% block title %}Collect Project :: Documento{% endblock %}

{% block import_style %}
	<style type="text/css">
		table.table_result {
			background-color: #ffffff;
			width: 100%;
			border: solid 1px #d4ccb0;
		}
		table.table_result td {
			padding-top: 10px;
			padding-bottom: 10px;			
		}
		table.table_result tr > td {
			border-bottom: solid 1px #d4ccb0;
		}
		table.table_result tr:last-child > td {
			border-bottom: none;
		}		
		/* REFACTOR: UNIR CODIGO ABAIXO COM O DA PAGINA DOCUMENT_PREVIEW.XHTML */
		table.attribute_table {
	        border-collapse:collapse;			
			width: 100%;	
		}
		
		table.attribute_table td  {
			/*border: 1px solid #d4ccb0;*/
			padding: 0px 3px;
		}		
		/* REFACTOR: UNIR CODIGO ABAIXO COM O DA PAGINA DOCUMENT_PREVIEW.XHTML */
		</style>
	<link rel="stylesheet" href="{{STATIC_URL}}css/app/search.css" />	
{% endblock %}

{% block startup_script %}
	<script type="text/javascript">
		$(document).ready(function() {
			/** Settings */
			/** Events */
			$("#uic_lookup_link").click(function(){
				$("#uic_form").submit(); 
				return false;			
			});
						
			$("a[rel=uic_preview_link]").live("click",function(){
				redirect(sprintf("/document/%s/preview",$(this).attr('href')));
				return false;
			});
			  
			$("a[rel=uic_classify_link]").live("click",function(){
				redirect(sprintf("/document/%s/classify",$(this).attr('href')));
				return false;
			});

			$("a[rel=uic_permission_link]").live("click",function(){
				redirect(sprintf("/document/%s/permission",$(this).attr('href')));								
				return false;
			});
			
			$("a[rel=uic_delete_link]").live("click",function(){
				var document_id = $(this).attr('href');								
				$("#uic_delete_dialog").dialog({
					title:"Deletar Documento",
					modal:true,
					buttons:[
						{
							text: "Yes",
							click: function() { 
								$("#uic_delete_form").attr("action", sprintf("/document/%s/delete",document_id));  
								$("#uic_delete_form").submit();
								return false;								
							}
						},
						{
							text: "No",
							click: function() { 
								$(this).dialog("close"); 
							}
						}					
					] 
				});
				return false;
			});
			
			
			
			$("a[rel=uic_category_facelet_link]").live("click",function(){
				$("#id_selected_category").val($(this).attr('href'));
				$("#uic_form").submit(); 
				return false;
			});
			
			
			$("#uic_clear_category_facelet_link").click(function(){
				$("#id_selected_category").val('');
				$("#uic_form").submit(); 
				return false;
			});
			
			$("a[rel=uic_tag_facelet_link]").live("click",function(){
				$("#id_selected_tag").val($(this).attr('href'));
				$("#uic_form").submit(); 
				return false;
			});
			
			
			$("#uic_clear_tag_facelet_link").click(function(){
				$("#id_selected_tag").val('');
				$("#uic_form").submit(); 
				return false;
			});		
			
			
			//TODO: Refactor unir com o document_preview.xhtml
			$("a[rel=uic_download-file_link]").live("click",function(){
				var key = $(this).attr('href');
				$.get(sprintf(sprintf("/api/storage/key/%s",key)),{}, function(data){					
					window.location=data.url_to_download; 
				}).error(function(){
					alert("Erro ao obter a url do arquivo");
				});					
				return false;	
			});
			
			//TODO: Refactor unir com o document_preview.xhtml
			$("a[rel=uic_visualize-file_link]").live("click",function(){
				var key = $(this).attr('href');
				$.get(sprintf(sprintf("/api/storage/key/%s",key)),{}, function(data){					
					$.fancybox.open([
					    {
					        href : data.url_to_preview,
					        title : data.filename,
					    }    
					], {
						type : 'iframe',
						padding    : 0,
    					autoResize : false,
						maxWidth   : 800,
						maxHeight  : 600,
						fitToView  : false,
						width	   : '70%',
						height	   : '70%',
						minWidth   : 400,
						minHeight  : 300,
					});
				}).error(function(){
					alert("Erro ao obter a url do arquivo");
				});					
				return false;				
			});	


		});	
	</script>
{% endblock %}

{% block trail %}
    <ul>
        <li><a href="#">Home</a></li>
        <li>Pesquisa</li>
    </ul>
{% endblock %}

{% block context_menu %}
	{% if query %}
		{% if categories.fields.category %}
			<div style="margin-top: 10px" class="ui-widget ui-widget-content ui-corner-all">
				<dl class="ui-context-menu">
					<dt>Categorias
					{% if form.selected_category.value %}
						<a id="uic_clear_category_facelet_link">
						<span class="floatr"><i class="icon-reply"></i></span>
						</a>
					{% endif %}
					</dt>
					{% for cat in categories.fields.category %}
						<dd><a rel="uic_category_facelet_link" href="{{cat.0}}">{{cat.0}} ({{cat.1}})</a></dd>
					{% endfor %}
				</dl>
			</div>
		{% endif %}
		{% if tags.fields.tags %}
			<div style="margin-top: 10px" class="ui-widget ui-widget-content ui-corner-all">
				<dl class="ui-context-menu">
					<dt>Tags
					{% if form.selected_tag.value %}
						<a id="uic_clear_tag_facelet_link">
						<span class="floatr"><i class="icon-reply"></i></span>
						</a>
					{% endif %}
					</dt>			
					{% for tag in tags.fields.tags %}
						<dd><a rel="uic_tag_facelet_link" href="{{tag.0}}">{{tag.0}} ({{tag.1}})</a></dd>
					{% endfor %}
				</dl>
			</div>
		{% endif %}
	{% endif %}
{% endblock %}

{% block content %}
	<!-- Header -->
	<div class="ui-app-header">
		<div class="ui-app-title">Pesquisar Documentos</div>
	</div>
	<!-- Search -->	
	<form id="uic_form" method="get" class="ui-form ui-widget ui-widget-content ui-corner-all">
		{% csrf_token %}
		{{form.selected_category}}		
		{{form.selected_tag}}			
		<div id="search_wrapper">
			{{form.q}}
			<a id="uic_lookup_link" href="">
				<i class="icon-search icon-large floatr"></i>
			</a>
		</div>
	</form>		
	<!-- Result -->
	{% if query %}
		<div class="ui-widget-header ui-corner-top" style="padding: 3px 10px 3px 10px; margin-top: 20px; border-bottom: none;">
			<div style="float: left"><p></span>Resultado da Busca</p></div>
			<div style="float: right;">
				<p style="font-weight: bold;"> {{page.paginator.count}} documento{{page.paginator.count|pluralize}} encontrado{{page.paginator.count|pluralize}}</p>
			</div>
			<div class="clear"></div>		
		</div>
		<div class="ui-widget-content ui-corner-bottom" style="padding: 10px 10px;">
	        {% if page.has_previous or page.has_next %}		        
		        <div class="ui-paginator">	
		        	<div>	        	
		        		{% if page.has_previous %}
		        			<a href="?q={{ query }}&amp;page={{ page.previous_page_number }}">
					        	<i class="icon-circle-arrow-left"></i>
					        </a>
				        {% endif %}		        		
			        	<b>1 de 2</b>
		        		{% if page.has_next %}
		        			<a href="?q={{ query }}&amp;page={{ page.next_page_number }}">
			        			<i class="icon-circle-arrow-right"></i>
			        		</a>
			        	{% endif %}
		        	</div>		        	
		        </div>
			{% endif %}
			<table class="table_result ui-corner-all">
				{% for result in page.object_list %}
					{% get_public_perms result.object as public_permissions %}
					{% get_obj_perms user for result.object as "document_permissions" %}
					<tr class="{% cycle 'row1' 'row2' %}">
						<td>
							<div style="margin: 5px 5px 5px 5px;">
								<div style="float: left;">
									<p style="font-weight: bold; display: inline">
										{% if result.object.category %}
											{% highlight result.object.category.title with query %}
										{% else %}
											<span class="ui-state-disabled">Sem Categoria</span>
										{% endif %}
									</p>
									<p style="font-size: 0.8em; display: inline; ">por</p>
									<p style="font-weight: bold; font-size: 0.8em; display: inline; ">{% highlight result.object.owner.username with query %}</p>
									<p style="font-size: 0.8em; display: inline; ">em</p>
									<p style="font-weight: bold; font-size: 0.8em; display: inline; ">{% highlight result.object.updated with query %}</p>
								</div>
								
								<div style="float: right" >
									<form id="uic_delete_form" method="post">
										{% csrf_token %}		
										<span class="icon-stack">
										<a rel="uic_preview_link" href="{{result.object.id}}">
											<b><i class="icon-th-list icon-large"></i><span class="hide"> Visualizar</span></b>
										</a>
										</span>
										{% if "change_document" in document_permissions %}
											<span class="icon-stack">										
											<a rel="uic_classify_link" href="{{result.object.id}}">
												<b><i class="icon-archive icon-large"></i><span class="hide"> Classificar</span></b>
											</a>
											</span>
											<span class="icon-stack">												
											<a rel="uic_permission_link" href="{{result.object.id}}">
												<b><i class="icon-unlock-alt icon-large"></i><span class="hide"> Permiss√µes</span></b>
											</a>	
											</span>								
										{% else %}	
											<span class="icon-stack">
											  <i class="icon-archive"></i>
											  <i class="icon-ban-circle icon-stack-base icon-color-red"></i>
											</span>		
											<span class="icon-stack">
											  <i class="icon-unlock-alt"></i>
											  <i class="icon-ban-circle icon-stack-base icon-color-red"></i>
											</span>																						
										{% endif %}
										{% if "delete_document" in document_permissions %}
											<a rel="uic_delete_link" href="{{result.object.id}}">
												<b><i class="icon-trash icon-large"></i><span class="hide"> Excluir</span></b>
											</a>								
										{% else %}
											<span class="icon-stack">
											  <i class="icon-trash"></i>
											  <i class="icon-ban-circle icon-stack-base icon-color-red"></i>
											</span>	
										{% endif %}
										<div id="uic_delete_dialog" class="hide">Voce tem certeza que deseja deletar o documento?</div>
									</form>
								</div>
								<div class="clear"></div>
								<div style="float: left; margin-bottom: 5px;">
									{% for att in result.object.all_attributes %}
										{% if att.value %}
											<div style="margin-bottom: 3px;">							
												<p style="display: inline; float: left;">{% highlight att.value.value with query %}</p>
												<div style="display: inline;">
													<p style="font-size: .7em; font-weight: bold; display: inline;" class="ui-state-disabled">
														<span class="ui-icon ui-icon-triangle-1-w" style="float: left;"></span>{{att.attribute.name}}
													</p>
												</div>
											</div>
										{% endif %}					
									{% endfor %}							
								</div>
								<div style="float: right; margin-top: 10px; width: 400px">
									{% for attach in result.object.all_files %}
										<div class="margin_min_bottom" style="font-size: 1.1em">
											<span>
												<a rel="uic_download-file_link" href="{{attach.file.key}}">
													<i class="icon-cloud-download icon-large"></i>
												</a>
											</span>
											<span>											
												<a rel="uic_visualize-file_link" href="{{attach.file.key}}">
													<i class="icon-external-link-sign icon-large"></i>
												</a>																				
											</span>												
											<span>{% highlight attach.file.filename with query %}</span>
											<small><i class="icon-angle-right ui-state-disabled"></i></small>
											<span style="font-size: 0.7em" class="ui-state-disabled">{{ attach.file.filesize|kilobytefy }}</span>
										</div>	
	
									{% endfor %}
								</div>
								<div class="clear"></div>							
								<div>
									{% for tag in result.object.all_tags  %}
										<div class="ui-state-active ui-corner-all" style="padding: 2px; margin-right: 3px; float: left">
											<p style="font-size: 0.8em; font-weight: bold">{% highlight tag.name with query %}</p>
										</div>
									{% endfor %}
									<div class="clear"></div>							
								</div>
	
							</div>							
						</td>
					</tr>	
				{% endfor %}
			</table>
		</div>
	{% endif %}
{% endblock %}