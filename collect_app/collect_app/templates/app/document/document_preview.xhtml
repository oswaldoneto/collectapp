{% extends "layout/template.xhtml" %}

{% load guardian_tags %}
{% load permission_checker %}
{% load kilobytefy %}

{% load verbatim %}

{% block title %}Collect Project :: Documento{% endblock %}

{% block import_style %}
	<style type="text/css">
	
		table.attribute_table {
			border: 1px solid #d4ccb0;
	        border-collapse:collapse;			
	        font-size: .9em;
			width: 100%;	
			background-color: white;  
		}
		
		table.attribute_table td  {
			border: 1px solid #d4ccb0;
			padding: 5px 5px;
		}
		
		table.attribute_table tr > td:first-child {
			font-weight: bold;
		}
	</style>
{% endblock %}

{% block startup_script %}

	{% get_public_perms doc as public_permissions %}
	{% get_obj_perms user for doc as "document_permissions" %}
		
	<script>
		$(document).data("document_id",'{{params.document}}')
	</script>
	<script type="text/javascript" src="{{STATIC_URL}}js/app/document/document_context_menu.js"></script>
	<script type="text/javascript" src="{{STATIC_URL}}js/app/document/document_preview.js"></script>
	<script type="text/javascript">
		$(document).ready(function() {
			
			
			

			$(".various").fancybox({
				maxWidth	: 800,
				maxHeight	: 600,
				fitToView	: false,
				width		: '70%',
				height		: '70%',
				autoSize	: false,
				closeClick	: true,
				openEffect	: 'none',
				closeEffect	: 'none'
			});

			
			
			/* Setting*/
			//Upload and Remove Button Setting Startup Logic
			{% if "change_document" not in public_permissions and "change_document" not in document_permissions %}
				$("#uic_classify_link").hide();				
				$("#uic_secure_link").hide();				
			{% endif %}				
			/* Events */
			$("a[rel=uic_delete_file_link]").click(function(){
				$.ajaxSetup({ traditional: true });
				$.post("/api/document/{{params.document}}/deattach",{
					'ids': [$(this).attr('href')]
				},function(data){
					redirect("/document/{{params.document}}/preview");													
				});				
				return false;
			});
			
			$("a[rel=uic_download-file_link]").click(function(){
				var key = $(this).attr('href');
				$.get(sprintf(sprintf("/api/storage/key/%s",key)),{}, function(data){					
					window.location=data; 
				}).error(function(){
					alert("Erro ao obter a url do arquivo");
				});					
				return false;				
			});
			
			
			$("#uic_classify_link").click(function(){
				redirect(sprintf("/document/%s/classify","{{params.document}}"));
			});
			$("#uic_secure_link").click(function(){
				redirect(sprintf("/document/%s/permission","{{params.document}}"));
			});
		});	
	</script>
{% endblock %}

{% block trail %}
    <ul>
        <li><a href="#">Home</a></li>
        <li>Documento</li>
        <li>Visualizar</li>
    </ul>
{% endblock %}

{% block context_menu %}
	{% include "app/document/document_context_menu.xhtml" %}
{% endblock %}

{% block content %}

	<!-- Permissão de Usuários -->
	<script id="uic_user_template" type="text/x-jquery-tmpl">
		{% verbatim %}
		<div class="margin_bottom_default">
			<div class="floatl">
				<i class="icon-user margin_right_default"></i>${name}	
			</div>
			<div class="floatr">
				<span class="margin_lr_double">
					{{if read == "True"}}
						<i class="icon-ok icon-large"></i>
					{{else}}
						<i class="icon-remove icon-large"></i>
					{{/if}}
					Visualizar
					</a>
				</span>
				<span class="margin_lr_double"> 
					{{if change == "True"}}
						<i class="icon-ok icon-large"></i>
					{{else}}
						<i class="icon-remove icon-large"></i>
					{{/if}}
					Alterar
				</span>				
				<span class="margin_lr_double"> 
					<a href=""> 
					{{if exclude == "True"}}
						<i class="icon-ok icon-large"></i>
					{{else}}
						<i class="icon-remove icon-large"></i>
					{{/if}}
					Excluir
					</a> 					
				</span>				
			</div>
			<div class="clear"></div>
		</div>
		{% endverbatim %}			
	</script>
	
	<!-- Permissão de Grupos -->
	<script id="uic_group_template" type="text/x-jquery-tmpl">
		{% verbatim %}
		<div class="margin_bottom_default">
			<div class="floatl">
				<i class="icon-group margin_right_default"></i>${name}	
			</div>
			<div class="floatr">
				<span class="margin_lr_double">
					{{if read == "True"}}
						<i class="icon-ok icon-large"></i>
					{{else}}
						<i class="icon-remove icon-large"></i>
					{{/if}}
					Visualizar
					</a>
				</span>
				<span class="margin_lr_double"> 
					{{if change == "True"}}
						<i class="icon-ok icon-large"></i>
					{{else}}
						<i class="icon-remove icon-large"></i>
					{{/if}}
					Alterar
				</span>				
				<span class="margin_lr_double"> 
					<a href=""> 
					{{if exclude == "True"}}
						<i class="icon-ok icon-large"></i>
					{{else}}
						<i class="icon-remove icon-large"></i>
					{{/if}}
					Excluir
					</a> 					
				</span>				
			</div>
			<div class="clear"></div>
		</div>
		{% endverbatim %}			
	</script>		

	
	<!-- TODO: Refactor 72 -->	
	<div class="ui-app-header">
		<div class="ui-app-title">Visualizar Documento</div>
	</div>
	
	<table id="uic_files" class="simple_table">
		<thead class="ui-widget-header">
			<th style="width: 5px"></th>
			<th style="width: 5px"></th>
			<th style="text-align: left">Título</th>
			<th style="text-align: left; width: 100px">Tamanho</th>
			<th style="text-align: left; width: 200px">Modificado</th>	
			<th style="width: 5px"></th>
		</thead>
		<tbody class="ui-widget-content">
			{% if not document %}
				{% for attach in attachment_list %}
					<tr>
						<td>
							<a rel="uic_download-file_link" href="{{attach.file.key}}">
								<i class="icon-cloud-download icon-large"></i>
							</a>							
						</td>
						<td>							
							<a class="various" data-fancybox-type="iframe" href="{{url_download}}/{{attach.file.key}}">
								<i class="icon-external-link-sign icon-large"></i>
							</a>
						</td>
						<td style="text-align: left">{{attach.file.filename}}</td>
						<td style="text-align: left">{{attach.file.filesize|kilobytefy}}</td>
						<td style="text-align: left">{{attach.file.updated|date:"d/m/Y H:i"}}</td>				
						<td>
							<a rel="uic_delete_file_link" href="{{doc_file.id}}">
								<i class="icon-trash icon-large"></i>
							</a>
						</td>
					</tr>
				{% endfor %}			
			{% else %}
				<tr>
					<td class="ui-state-disabled" colspan="4" align="center">Nenhum arquivo anexado</td>
				</tr>
			{% endif %}
		</tbody>
	</table>




	<div class="ui-widget-header ui-corner-top" style="padding: 3px 10px 3px 10px; margin-top: 20px; border-bottom: none;">
		<div style="float: left">Classificação</div>
		<div style="float: right; cursor: pointer;" class="">
			<a id="uic_classify_link"><span class="ui-icon ui-icon-folder-open" style="float: left"></span></a>
		</div>
		<div class="clear"></div>		
	</div>
	<div class="ui-widget-content ui-corner-bottom" style="padding: 10px 10px;">
		{% if category %}
			<div style="float: left; width: 460px;">
				<div style="font-weight: bold; margin-bottom: 5px;">{{category.title}}</div>
				<div>
					<table class="attribute_table">
						<tbody>
							{% for doc_att in attribute_list %}
								<tr><td>{{doc_att.attribute.name}}</td><td>{{doc_att.value.value}}</td></tr>					
							{% endfor %}
						</tbody>
					</table>
				</div>
			</div>
			<div style="float: right; width: 280px;">
				<div style="font-weight: bold; margin-bottom: 5px;">Tags</div>
				<div>
					{% for tag in tag_list %}
						<p><span class="ui-icon ui-icon-tag" style="float: left;"></span>{{tag.name}}</p>				
					{% endfor %}
				</div>
			</div>
			<div class="clear"></div>
		{% else %}
			<div class="ui-state-disabled">Sem classificação</div>		
		{% endif %}
	</div>
	
	
	
	<div class="ui-widget-header ui-corner-top" style="padding: 3px 10px 3px 10px; margin-top: 20px; border-bottom: none;">
		<div style="float: left">Permissões</div>
		<div style="float: right; cursor: pointer;">
			<a id="uic_secure_link">
				<span class="ui-icon ui-icon-folder-open" style="float: left"></span>
			</a>
		</div>
		<div class="clear"></div>		
	</div>
	<div class="ui-widget-content ui-corner-bottom" style="padding: 10px 10px;">
		<div id="uic_users_container"></div>
		<div id="uic_group_container"></div>
	</div>
	
	
	<!-- Change History -->
	<div class="ui-widget-header ui-corner-top" style="padding: 3px 10px 3px 10px; margin-top: 20px; border-bottom: none;">
		<div>Histórico de Alteração</div>
	</div>
	<div class="ui-widget-content ui-corner-bottom" style="padding: 10px 10px;">
		<div>
			<p><strong>Dono</strong> {{ doc.owner }}</p>			
		</div>
		<div class="floatl" style="width: 50%;">
			<p><strong>Criado em</strong> {{ doc.created }}</p>			
		</div>
		<div class="floatr" style="width: 50%;">
			<p><strong>Alterado em</strong> {{ doc.updated }} <strong>por</strong> {{doc.last_update_user}}</p>						
		</div>
		<div class="clear"></div>
	</div>	
	
	<!-- TODO: REMOVE -->
	{% if show_back_to_search %}
		<!--
		<a>
		<span id="uic_back_button" class="floatl margin_top_double">
			<i class="icon-arrow-left icon-large"></i> <b>Voltar</b>
		</span>
		</a>
		-->
	{% endif %}
		
{% endblock %}