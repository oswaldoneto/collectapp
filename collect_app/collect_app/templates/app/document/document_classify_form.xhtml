{% extends "layout/template.xhtml" %}

{% load guardian_tags %}
{% load permission_checker %}


{% block import_style %}
    <style type="text/css">
        #id_category {
            width: 744px
        }
        #uic_tag_table tr:first-child td:first-child {
            width: 1%;
        }
    </style>
{% endblock %}

{% block import_script %}
    <script>
        $(document).data("document_id",'{{params.document}}')
    </script>
    <script type="text/javascript" src="{{STATIC_URL}}js/app/document/document_context_menu.js"></script>
    <script type="text/javascript" src="{{STATIC_URL}}js/app/document/classify_form.js"></script>
{% endblock %}

{% block startup_script %}
    <script type="text/javascript">
        $(document).ready(function() {
            /* Setting  */
            $uic_category_select = $("#id_category").multiselect({
               multiple: false,
               header: "Selecione uma categoria",
               selectedList: 1
            });
            $uic_save_button = $("#uic_save_button").button();
            $uic_cancel_button = $("#uic_cancel_button").button();
            $uic_unclassify_button = $("#uic_unclassify_button").button({
                text: true,
                icons: {
                    primary: "ui-icon-trash"
                }
            });
            $uic_addattr_button = $(".uic_addattr_button").button({
                text: true,
                icons: {
                    primary: "ui-icon-plus"
                }
            });

            /* Events */
            $uic_addattr_button.click(function(){
                {% if params.document %}
                    doc_id = "{{params.document}}";
                    att_id = this.value;
                    $("#uic_form").attr("action", sprintf("/document/%s/classify/attribute/%s/add",doc_id,att_id));
                    $("#uic_form").submit();
                {% endif %}
            });
            $uic_category_select.change(function() {
                var doc_id = "new";
                {% if params.document %}
                    doc_id = "{{params.document}}";
                {% endif %}
                redirect(sprintf("/document/%s/classify/category/%s",doc_id,$uic_category_select.val()));
            });
            $uic_save_button.click(function() {
                $("#uic_form").submit();
                return false;
            });
            $uic_cancel_button.click(function(){
                {% if params.document %}
                    redirect(sprintf("/document/%s/preview","{{params.document}}"));
                {% else %}
                    redirect("/document/new/classify");
                {% endif %}
                return false;
            });
            $uic_unclassify_button.click(function() {
                $("#uic_delete_dialog").dialog({
                    title:"Deletar Classificação",
                    buttons:[
                        {
                            text: "Yes",
                            click: function() {
                                $("#uic_form").attr("action", sprintf("/document/%s/classify/delete","{{params.document}}"));
                                $("#uic_form").submit();
                                return false;
                            }
                        },
                        {
                            text: "No",
                            click: function() {
                                $(this).dialog("close");
                            }
                        }
                    ]
                });
            });
        });
    </script>
{% endblock %}


{% block trail %}
    <ul>
        <li><a href="#">Home</a></li>
        <li>Documento</li>
        <li>Classificação</li>
    </ul>
{% endblock %}

{% block context_menu %}
    {% include "app/document/document_context_menu.xhtml" %}
{% endblock %}

{% block content %}

    <!--------------------------------------------->
    <!-- TODO: Refactor export style to css file -->
    <!--------------------------------------------->

    <div class="ui-app-header">
        <div class="ui-app-title">Classificação do Documento</div>
        <div class="ui-app-command">
            {% if show_tags %}
                <div class="floatr">
                    <button id="uic_unclassify_button">Deletar Classificação</button>
                </div>
                <div id="uic_delete_dialog" class="hide">Voce tem certeza que deseja deletar a classificação deste documento?</div>
            {% endif %}
        </div>
    </div>
    <form id="uic_form" method="post" class="ui-form ui-widget ui-widget-content ui-corner-all">
        {% csrf_token %}

        <!--------------------------------------------->
        <!-- TODO: Ticket #1                         -->
        <!--------------------------------------------->

        <div class="ui-state-disabled" style="margin-bottom: 5px">
            {% if not form.category.value %}
                <p>Selecione uma categoria para começar</p>
            {% endif %}
        </div>
        <div>{{form.category}}</div>
        {% if form.category.value %}
            <table class="table_form">
                {% for field in form  %}
                    {% if field.html_name != "category" %}
                        <tr>
                            <td class="label">{{field.label}}</td>
                            <td class="component">{{field}}</td>
                            <td class="error">{{field.errors}}</td>
                        </tr>
                    {% endif %}
                {% endfor %}

                {% if new_attributes %}
                    {% for new_attr in new_attributes  %}
                        <tr>
                            <td class="label">{{new_attr.name}}</p>
                            </td>
                            <td class="component">
                                <button class="uic_addattr_button" value="{{new_attr.id}}">Adicionar</button>
                            </td>
                        </tr>
                    {% endfor %}
                {% endif %}


            </table>
            <div class="ui-form-button">
                <input type="button" value="Save" id="uic_save_button">
                <input type="button" value="Cancel" id="uic_cancel_button">
            </div>
        {% endif %}
        <div class="clear"></div>

        <!--------------------------------------------->
        <!-- TODO: Ticket #1                         -->
        <!--------------------------------------------->
    </form>

{% endblock %}